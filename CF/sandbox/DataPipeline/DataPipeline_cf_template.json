{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "DataPipeline Export DynamoDb to S3 bucket",
  "Parameters": {
    "DataPipelineRole": {
      "Type": "String",
      "Description": "Role for DataPipeline Execution"
    },
    "EC2Role": {
      "Type": "String",
      "Description": "Role for EC2"
    },
    "S3OutputLoc": {
      "Type": "String",
      "Description": "S3 output Buckate Name"
    },
    "TableName": {
      "Type": "String",
      "Description": "DynamoDB Table Name"
    }
  },
  "Resources": {
    "DynamoDBInputS3OutputHive": {
      "Type": "AWS::DataPipeline::Pipeline",
      "Properties": {
        "Name": "DynamoDBInputS3OutputHive",
        "Description": "Pipeline to backup DynamoDB data to S3",
        "Activate": "true",
        "ParameterObjects": [
          {
            "Id": "myDDBReadThroughputRatio",
            "Attributes": [
              {
                "Key": "description",
                "StringValue": "DynamoDB read throughput ratio"
              },
              {
                "Key": "type",
                "StringValue": "Double"
              },
              {
                "Key": "default",
                "StringValue": "0.25"
              }
            ]
          },
          {
            "Id": "myDDBRegion",
            "Attributes": [
              {
                "Key": "description",
                "StringValue": "Region of the DynamoDB table"
              },
              {
                "Key": "type",
                "StringValue": "String"
              },
              {
                "Key": "default",
                "StringValue": "us-east-2"
              }
            ]
          },
          {
            "Id": "myOutputS3Loc",
            "Attributes": [
              {
                "Key": "description",
                "StringValue": "S3 output bucket"
              },
              {
                "Key": "type",
                "StringValue": "AWS::S3::ObjectKey"
              },
              {
                "Key": "default",
                "StringValue": {
                  "Fn::Join": [
                    "",
                    [
                      "s3://",
                      {
                        "Ref": "S3OutputLoc"
                      }
                    ]
                  ]
                }
              }
            ]
          },
          {
            "Id": "myDDBTableName",
            "Attributes": [
              {
                "Key": "description",
                "StringValue": {
                  "Ref": "TableName"
                }
              },
              {
                "Key": "type",
                "StringValue": "String"
              }
            ]
          }
        ],
        "ParameterValues": [
          {
            "Id": "myDDBTableName",
            "StringValue": {
              "Ref": "TableName"
            }
          }
        ],
        "PipelineObjects": [
          {
            "Id": "S3BackupLocation",
            "Name": "Copy data to this S3 location",
            "Fields": [
              {
                "Key": "type",
                "StringValue": "S3DataNode"
              },
              {
                "Key": "dataFormat",
                "RefValue": "DDBExportFormat"
              },
              {
                "Key": "directoryPath",
                "StringValue": "#{myOutputS3Loc}/#{format(@scheduledStartTime, 'YYYY-MM-dd-HH-mm-ss')}"
              }
            ]
          },
          {
            "Id": "DDBSourceTable",
            "Name": "DDBSourceTable",
            "Fields": [
              {
                "Key": "tableName",
                "StringValue": "#{myDDBTableName}"
              },
              {
                "Key": "type",
                "StringValue": "DynamoDBDataNode"
              },
              {
                "Key": "dataFormat",
                "RefValue": "DDBExportFormat"
              },
              {
                "Key": "readThroughputPercent",
                "StringValue": "#{myDDBReadThroughputRatio}"
              }
            ]
          },
          {
            "Id": "DDBExportFormat",
            "Name": "DDBExportFormat",
            "Fields": [
              {
                "Key": "type",
                "StringValue": "DynamoDBExportDataFormat"
              }
            ]
          },
          {
            "Id": "TableBackupActivity",
            "Name": "TableBackupActivity",
            "Fields": [
              {
                "Key": "resizeClusterBeforeRunning",
                "StringValue": "true"
              },
              {
                "Key": "type",
                "StringValue": "HiveCopyActivity"
              },
              {
                "Key": "input",
                "RefValue": "DDBSourceTable"
              },
              {
                "Key": "runsOn",
                "RefValue": "EmrClusterForBackup"
              },
              {
                "Key": "output",
                "RefValue": "S3BackupLocation"
              }
            ]
          },
          {
            "Id": "DefaultSchedule",
            "Name": "RunOnce",
            "Fields": [
              {
                "Key": "occurrences",
                "StringValue": "1"
              },
              {
                "Key": "startAt",
                "StringValue": "FIRST_ACTIVATION_DATE_TIME"
              },
              {
                "Key": "type",
                "StringValue": "Schedule"
              },
              {
                "Key": "period",
                "StringValue": "1 Day"
              }
            ]
          },
          {
            "Id": "Default",
            "Name": "Default",
            "Fields": [
              {
                "Key": "type",
                "StringValue": "Default"
              },
              {
                "Key": "scheduleType",
                "StringValue": "cron"       #########  ONDEMAND  for on activate  cron  for schedule
              },
              {
                "Key": "failureAndRerunMode",
                "StringValue": "CASCADE"
              },
              {
                "Key": "role",
                "StringValue": {
                  "Ref": "DataPipelineRole"
                }
              },
              {
                "Key": "resourceRole",
                "StringValue": {
                  "Ref": "EC2Role"
                }
              },
              {
                "Key": "schedule",
                "RefValue": "DefaultSchedule"
              }
            ]
          },
          {
            "Id": "EmrClusterForBackup",
            "Name": "EmrClusterForBackup",
            "Fields": [
              {
                "Key": "terminateAfter",
                "StringValue": "2 Hours"
              },
              {
                "Key": "amiVersion",
                "StringValue": "3.3.2"
              },
              {
                "Key": "masterInstanceType",
                "StringValue": "m1.medium"
              },
              {
                "Key": "coreInstanceType",
                "StringValue": "m1.medium"
              },
              {
                "Key": "coreInstanceCount",
                "StringValue": "1"
              },
              {
                "Key": "type",
                "StringValue": "EmrCluster"
              }
            ]
          }
        ]
      }
    }
  }
}