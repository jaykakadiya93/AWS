{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "S3 Bucket Creation and ADD S3 Trigger To Lambda",
  "Parameters": {
    "BucketName": {
      "Description": "S3 bucket name",
      "Type": "String"
    },
    "FunctionName": {
      "Description": "Lambda Function Name",
      "Type": "String"
    }
  },
  "Resources": {
    "LambdaInvokePermission": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "Action": "lambda:InvokeFunction",
        "FunctionName": {
          "Fn::Join": [
            ":",
            [
              "arn",
              "aws",
              "lambda",
              {
                "Ref": "AWS::Region"
              },
              {
                "Ref": "AWS::AccountId"
              },
              "function",
              {
                "Ref": "FunctionName"
              }
            ]
          ]
        },
        "Principal": "s3.amazonaws.com",
        "SourceAccount": {
          "Ref": "AWS::AccountId"
        },
        "SourceArn": {
          "Fn::Join": [
            ":",
            [
              "arn",
              "aws",
              "s3",
              "",
              "",
              {
                "Ref": "BucketName"
              }
            ]
          ]
        }
      }
    },
    "InputDataBucket": {
      "Type": "AWS::S3::Bucket",
      "DependsOn": [
        "LambdaInvokePermission"
      ],
      "Properties": {
        "BucketName": {
          "Ref": "BucketName"
        },
        "NotificationConfiguration": {
          "LambdaConfigurations": [
            {
              "Function": {
                "Fn::Join": [
                  ":",
                  [
                    "arn",
                    "aws",
                    "lambda",
                    {
                      "Ref": "AWS::Region"
                    },
                    {
                      "Ref": "AWS::AccountId"
                    },
                    "function",
                    {
                      "Ref": "FunctionName"
                    }
                  ]
                ]
              },
              "Event": "s3:ObjectCreated:*",
              "Filter": {
                "S3Key": {
                  "Rules": [
                    {
                      "Name": "prefix",
                      "Value": "input/"
                    },
                    {
                      "Name": "suffix",
                      "Value": "csv"
                    }
                  ]
                }
              }
            }
          ]
        },
        "NotificationConfiguration": {
          "LambdaConfigurations": [
            {
              "Function": {
                "Fn::Join": [
                  ":",
                  [
                    "arn",
                    "aws",
                    "lambda",
                    {
                      "Ref": "AWS::Region"
                    },
                    {
                      "Ref": "AWS::AccountId"
                    },
                    "function",
                    {
                      "Ref": "FunctionName"
                    }
                  ]
                ]
              },
              "Event": "s3:ObjectCreated:*",
              "Filter": {
                "S3Key": {
                  "Rules": [
                    {
                      "Name": "prefix",
                      "Value": "input/"
                    },
                    {
                      "Name": "suffix",
                      "Value": "csv"
                    }
                  ]
                }
              }
            }
          ]
        }
      }
    }
  }
}